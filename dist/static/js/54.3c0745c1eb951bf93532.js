webpackJsonp([54],{"+x0k":function(e,r){},"2SsV":function(e,r,t){"use strict";Object.defineProperty(r,"__esModule",{value:!0});var o=t("aFK5"),a=t.n(o),i=t("woOf"),l=t.n(i),n={name:"MakeOffer",data:function(){return{Form:{customer_id:"",products:[],category:"",product_brand_id:"",operate:1,serviceor_id:"",formula_id:null},Rules:{customer_id:[{required:!0,trigger:"blur",message:"请选择客户"}],products:[{required:!0,trigger:"blur",message:"请选择产品规格"}],category:[{required:!0,trigger:"blur",message:"请选择分类"}],product_brand_id:[{required:!0,trigger:"blur",message:"请选择品牌"}],operate:[{required:!0,trigger:"blur"}],operate_val:[{validator:this.validateField,trigger:"blur"}],serviceor_id:[{required:!0,trigger:"blur",message:"请选择服务人员"}],version_id:[{required:!0,trigger:"blur",message:"请选择价格版本"}],formula_id:[{required:!0,trigger:"blur",message:"请选择计算公式"}]},operates:[{label:"x",value:1},{label:"÷",value:2},{label:"+",value:3},{label:"-",value:4}],RemoteLoading:!1,submiting:!1,defaultField:{},FieldMap:{},AuthorizeMsg:"",mode:0,AppendFormulaDialog:!1,AppendFormulaForm:[],errmsg:null,refreshStatus:!0,FormulaAppendSuccessRows:[]}},created:function(){this.$store.dispatch("MakeOfferParams")},methods:{handleClose:function(){this.$store.dispatch("SetBaseProductConfig",{field:"Price.MakeOffer.visible",value:!1})},handleOpen:function(){},handleCheck:function(e,r){this.Form.products=r.checkedKeys},remoteMethod:function(e){var r=this;e&&(this.RemoteLoading=!0,this.$store.dispatch("QueryCustomer",{keyword:e}).then(function(){r.RemoteLoading=!1}))},submit:function(){var e=this;this.$refs.form.validate(function(r){r&&(console.log(e.Form),e.$store.dispatch("CreateOffer",e.Form).then(function(){var r=e.$store.state.user.CreateOffer;"success"==r.status?(e.$notify.success("创建成功！请到历史报价下载报价文件"),e.$refs.form.resetFields(),e.handleClose()):e.$notify.error("操作失败,"+r.errmsg)}))})},CategoryChange:function(){this.Form.product_brand_id="",this.Form.products=[]},BrandChange:function(e){var r=this;this.brands.forEach(function(t){e==t.value&&(r.mode=t.mode)})},validateField:function(e,r,t){/^[1-9]+(\.?\d+){0,1}$/.test(r)?t():t(new Error("请输入数字"))},handleCustSelect:function(e){this.customers.forEach(function(e){e.value})},FormulaAddField:function(e){this.AppendFormulaForm.push({type:e,value:""})},FormulaFormParamChanged:function(){this.errmsg=null},FormulaClearAll:function(){this.AppendFormulaForm=[],this.errmsg=null},RemoveLast:function(){this.AppendFormulaForm.pop()},PriceVersuibChange:function(e){this.$store.dispatch("LoadProductsFromVersion",{id:e})},SaveFormula:function(){var e=this,r=[],t=0,o=[],i=this.FormmulaParams;this.AppendFormulaForm.forEach(function(e){o.push(l()({},e))}),o.map(function(e){var r=i.find(function(r){return r.value==e.value});return r&&(e.type=r.type),e});var n=o.every(function(o){if("("==o.value&&++t,")"==o.value&&--t,a()(r).length>0){if("operator"==r.type&&"operator"==o.type)return e.errmsg="不能连续使用两个运算符",r=o,!1;if("field"==r.type&&"field"==o.type)return e.errmsg="不能连续使用两个字段",r=o,!1;if("operator"==r.type&&")"==o.valud)return e.errmsg='运算符后面不能接括号 ")"',r=o,!1;if("("==r.value&&"operator"==o.type)return e.errmsg="运算符前面不能使用括号",r=o,!1;if("("==r.value&&")"==o.value)return e.errmsg="不能连续使用两个括号",r=o,!1;if(")"==r.value&&"field"==o.type)return e.errmsg="右括号后不可以连接字段",r=o,!1}else if("operator"==o.type)return e.errmsg="请检查符号的合法性",r=o,!1;if("numeric"==o.type){if(""==o.value)return e.errmsg="输入框内容不能为空",!1;if(a()(r).length>0&&("field"==r.type||")"==r.value))return e.errmsg="输入内容之前不能是字段和右括号",!1}return r=o,!0});0!=t&&1==n&&(this.errmsg="请检查括号的合法性",n=!1),console.log(o),n&&this.$store.dispatch("AppendFormula",{params:o,tableId:this.Form.product_brand_id}).then(function(r){if(console.log(r),"success"==r.status){var t={label:r.formula,value:r.id};e.FormulaAppendSuccessRows.push(t),e.AppendFormulaDialog=!1,e.Form.formula_id=r.id}else e.errmsg=r.errmsg})}},computed:{FormulaOptions:function(){var e=this,r=[],t=this.brands.find(function(r){return r.value==e.Form.product_brand_id});return void 0!==t&&t.formulas.length>0&&(r=t.formulas),this.FormulaAppendSuccessRows.length>0&&this.FormulaAppendSuccessRows.forEach(function(e){r.unshift(e)}),r},CanAppendNumeric:function(){return this.AppendFormulaForm.length>0&&"numeric"==this.AppendFormulaForm[this.AppendFormulaForm.length-1].type},AppendFormulaFormTostring:function(){var e="";for(var r in this.AppendFormulaForm)e+=" "+this.AppendFormulaForm[r].value;return e},visible:function(){return this.$store.state.user.BaseProduct.Price.MakeOffer.visible},customers:function(){var e=this.$store.state.user.QueryCustomer,r=[];return e.forEach(function(e){r.push({label:e.name,value:e.id})}),r},categorys:function(){return this.$store.state.user.MakeOfferParams},brands:function(){var e=this,r=[];return this.categorys.forEach(function(t){t.value==e.Form.category&&(r=t.childrens)}),console.log(r),r},treeData:function(){var e=[{label:"全部",id:0,children:[]}];return this.$store.state.user.LoadProductsFromVersion.forEach(function(r){e[0].children.push({label:r.label,id:r.value,childred:[]})}),e},users:function(){return this.$store.state.user.CostRole.users},versions:function(){var e=this,r=[];return this.brands.forEach(function(t){t.value==e.Form.product_brand_id&&(r=t.versions)}),r},FormmulaParams:function(){var e=this;return this.brands.length>0&&this.Form.product_brand_id?this.brands.find(function(r){return r.value==e.Form.product_brand_id}).formula_param:[]}}},s={render:function(){var e=this,r=e.$createElement,t=e._self._c||r;return t("div",{staticClass:"makeoffer-wallpaper"},[t("el-dialog",{attrs:{title:"开始报价",visible:e.visible,"before-close":e.handleClose,width:"40%"},on:{"update:visible":function(r){e.visible=r},open:e.handleOpen}},[t("el-form",{ref:"form",attrs:{model:e.Form,rules:e.Rules,"label-width":"120px"}},[t("el-form-item",{attrs:{label:"客户名称",prop:"customer_id",error:e.AuthorizeMsg}},[t("el-select",{attrs:{remote:"",filterable:"","remote-method":e.remoteMethod,loading:e.RemoteLoading},on:{change:e.handleCustSelect},model:{value:e.Form.customer_id,callback:function(r){e.$set(e.Form,"customer_id",r)},expression:"Form.customer_id"}},e._l(e.customers,function(e,r){return t("el-option",{key:r,attrs:{label:e.label,value:e.value}})})),e._v(" "),e.AuthorizeMsg?t("el-button",{attrs:{type:"success",size:"mini"}},[e._v("申请授权")]):e._e()],1),e._v(" "),t("el-form-item",{attrs:{label:"选择分类",prop:"category"}},[t("el-select",{on:{change:e.CategoryChange},model:{value:e.Form.category,callback:function(r){e.$set(e.Form,"category",r)},expression:"Form.category"}},e._l(e.categorys,function(e,r){return t("el-option",{key:r,attrs:{label:e.label,value:e.value}})}))],1),e._v(" "),t("el-form-item",{attrs:{label:"选择品牌",prop:"product_brand_id"}},[t("el-select",{on:{change:e.BrandChange},model:{value:e.Form.product_brand_id,callback:function(r){e.$set(e.Form,"product_brand_id",r)},expression:"Form.product_brand_id"}},e._l(e.brands,function(e,r){return t("el-option",{key:r,attrs:{label:e.label,value:e.value}})}))],1),e._v(" "),t("el-form-item",{attrs:{label:"服务人员",prop:"serviceor_id"}},[t("el-select",{model:{value:e.Form.serviceor_id,callback:function(r){e.$set(e.Form,"serviceor_id",r)},expression:"Form.serviceor_id"}},e._l(e.users,function(e,r){return t("el-option",{key:r,attrs:{label:e,value:r}})}))],1),e._v(" "),t("el-form-item",{attrs:{label:"价格版本",prop:"version_id"}},[t("el-select",{on:{change:e.PriceVersuibChange},model:{value:e.Form.version_id,callback:function(r){e.$set(e.Form,"version_id",r)},expression:"Form.version_id"}},e._l(e.versions,function(e,r){return t("el-option",{key:r,attrs:{label:e.label,value:e.value}})}))],1),e._v(" "),t("el-form-item",{attrs:{label:"计算公式",prop:"formula_id"}},[t("div",{staticClass:"operate",staticStyle:{display:"flex"}},[t("el-select",{model:{value:e.Form.formula_id,callback:function(r){e.$set(e.Form,"formula_id",r)},expression:"Form.formula_id"}},e._l(e.FormulaOptions,function(e,r){return t("el-option",{key:r,attrs:{label:e.label,value:e.value}})})),e._v(" "),t("div",{staticStyle:{"margin-left":"5px"}},[t("el-button",{attrs:{type:"success",size:"mini",disabled:!e.Form.product_brand_id},nativeOn:{click:function(r){e.AppendFormulaDialog=!0}}},[e._v("添加公式")])],1)],1)]),e._v(" "),e.visible?t("el-form-item",{attrs:{label:"选择规格",prop:"products"}},[t("el-tree",{attrs:{data:e.treeData,"show-checkbox":"","node-key":"id","default-expanded-keys":["0"]},on:{check:e.handleCheck}})],1):e._e()],1),e._v(" "),t("span",{staticClass:"dialog-footer",attrs:{slot:"footer"},slot:"footer"},[t("el-button",{on:{click:e.handleClose}},[e._v("取 消")]),e._v(" "),t("el-button",{attrs:{type:"primary",loading:e.submiting},nativeOn:{click:function(r){return e.submit(r)}}},[e._v("提 交")])],1)],1),e._v(" "),t("el-dialog",{attrs:{title:"设计公式",visible:e.AppendFormulaDialog,width:"40%"},on:{"update:visible":function(r){e.AppendFormulaDialog=r}}},[t("div",{staticClass:"AppendFormulaDialog_body"},[t("div",{staticClass:"formula-container"},[t("div",{staticClass:"add-param"},[t("el-button",{attrs:{size:"mini",type:"info"},nativeOn:{click:function(r){e.FormulaAddField("field")}}},[e._v("增加操作符或字段")]),e._v(" "),t("el-button",{attrs:{size:"mini",type:"info",disabled:e.CanAppendNumeric},nativeOn:{click:function(r){e.FormulaAddField("numeric")}}},[e._v("增加数值")])],1),e._v(" "),e.refreshStatus?t("p",[e._v(e._s(e.AppendFormulaFormTostring))]):e._e(),e._v(" "),t("p",{staticClass:"errmsg",staticStyle:{"font-size":"12px",color:"red"}},[e._v(e._s(e.errmsg))]),e._v(" "),t("el-form",{staticClass:"FormulaForm",attrs:{inline:!0}},e._l(e.AppendFormulaForm,function(r,o){return t("el-form-item",{key:o},["field"==r.type?t("el-select",{on:{change:e.FormulaFormParamChanged},model:{value:r.value,callback:function(t){e.$set(r,"value",t)},expression:"item.value"}},e._l(e.FormmulaParams,function(e,r){return t("el-option",{key:r,attrs:{label:e.label,value:e.value}})})):t("el-input",{model:{value:r.value,callback:function(t){e.$set(r,"value",t)},expression:"item.value"}})],1)}))],1)]),e._v(" "),t("span",{staticClass:"dialog-footer",attrs:{slot:"footer"},slot:"footer"},[t("el-button",{on:{click:e.FormulaClearAll}},[e._v("清 空")]),e._v(" "),t("el-button",{on:{click:e.RemoveLast}},[e._v("撤销上一步")]),e._v(" "),t("el-button",{attrs:{type:"primary"},nativeOn:{click:function(r){return e.SaveFormula(r)}}},[e._v("保 存")])],1)])],1)},staticRenderFns:[]};var u=t("VU/8")(n,s,!1,function(e){t("+x0k")},null,null);r.default=u.exports},"G5/o":function(e,r,t){t("uqUo")("getOwnPropertyNames",function(){return t("Rrel").f})},aFK5:function(e,r,t){e.exports={default:t("gAsd"),__esModule:!0}},gAsd:function(e,r,t){t("G5/o");var o=t("FeBl").Object;e.exports=function(e){return o.getOwnPropertyNames(e)}}});